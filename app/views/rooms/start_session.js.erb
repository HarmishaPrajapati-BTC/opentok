API_KEY = '47001474';
var sessionId = "<%= @room.vonage_session_id %>"
var token = "<%= @token %>"
// connect to session
var session = OT.initSession(API_KEY, sessionId);
// create publisher
var publisher = OT.initPublisher('publisher', {
  insertMode: 'append',
  fitMode: 'contain',
  name: 'John'
}, handleError);

// Connect to the session
session.connect(token, function(error) {
  // If the connection is successful, initialize a publisher and publish to the session
  if (error) {
    handleError(error);
  } else {
    session.publish(publisher, handleError);
  }
});
function handleError(error) {
  if (error) {
    alert(error.message);
  }
}
var enableVideo=true;
$('#disablevideopub').on('click', function() {
  if(enableVideo)
  {
    publisher.publishVideo(false);
    enableVideo=false;
  } else
  {
    publisher.publishVideo(true);
    enableVideo=true;
  }
});
var connectionCount = 0;
session.on({
  connectionCreated: function (event) {
    connectionCount++;
    if (event.connection.connectionId !== session.connection.connectionId &&
      event.connection.creationTime < session.connection.creationTime){
      console.log(connectionCount)
      if (connectionCount > 1){
        alert('disconnecting this room is already full')
        session.disconnect();
      }
    }
  }
})
session.connect(token, function(err) {
});
// create subscriber
session.on('streamCreated', function(event) {
  subscriber = session.subscribe(event.stream, 'subscribers', {
    insertMode: 'append',
    fitMode: 'contain',
    showControls: true,
    name: 'Herry',
    style: { nameDisplayMode: "on" }
    }, handleError);
  function handleError(error) {
    if (error) {
      alert(error.message);
    }
  }
  $('#disablevideosub').on('click', function() {
    domElement = document.getElementById(subscriber.id);
    console.log(domElement)
    subscriber.setStyle({videoDisabledDisplayMode: 'on'});
  })
});
